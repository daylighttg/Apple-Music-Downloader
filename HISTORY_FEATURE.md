# 📜 历史记录与进度管理功能说明

## 功能概述

历史记录系统为批量下载任务提供智能断点续传和进度管理功能，支持任务中断后自动恢复，避免重复下载。

## 主要特性

### 1. 📁 自动历史记录管理
- 在项目根目录自动创建 `history` 文件夹
- 每次批量任务生成独立的历史记录文件
- 记录格式：`{任务文件名}_{时间戳}.json`

### 2. 🔄 智能任务恢复
- **自动检测**：新任务启动前自动比对历史记录
- **智能跳过**：自动跳过已成功下载的专辑
- **进度显示**：清晰显示跳过数量和剩余任务

### 3. 💾 专辑级别断点续传
- 支持任务中断后从断点继续
- 示例：1~10号专辑，中断在2号，恢复时自动从3号开始
- 已完成的专辑不会重复下载

## 使用方法

### 基础使用

```bash
# 第一次运行
./apple-music-downloader 经典专辑.txt

# 如果中断，再次运行相同命令
./apple-music-downloader 经典专辑.txt
# 程序会自动检测历史记录，跳过已完成的专辑
```

### 运行示例

#### 首次运行
```bash
$ ./apple-music-downloader 经典专辑.txt

📊 从文件 经典专辑.txt 中解析到 63 个链接

📋 初始链接总数: 63
🔄 开始预处理链接...

📋 ========== 开始下载任务 ==========
📝 任务总数: 63
⚡ 执行模式: 串行（按顺序逐个下载）
📦 专辑内并发: 由配置文件控制
📜 历史记录: 已启用
====================================

🧾 [1/63] 开始处理: https://music.apple.com/...
🎤 歌手: Antonio Vivaldi
💽 专辑: Vivaldi: The Four Seasons
...
```

#### 中断后恢复（假设完成了20个专辑后中断）
```bash
$ ./apple-music-downloader 经典专辑.txt

📊 从文件 经典专辑.txt 中解析到 63 个链接

📋 初始链接总数: 63
🔄 开始预处理链接...

📜 历史记录检测: 发现 20 个已完成的任务
⏭️  已自动跳过，剩余 43 个任务

📋 ========== 开始下载任务 ==========
📝 任务总数: 43
⚡ 执行模式: 串行（按顺序逐个下载）
📦 专辑内并发: 由配置文件控制
📜 历史记录: 已启用
====================================

🧾 [1/43] 开始处理: https://music.apple.com/...
（从第21个专辑继续）
```

#### 全部完成后再次运行
```bash
$ ./apple-music-downloader 经典专辑.txt

📊 从文件 经典专辑.txt 中解析到 63 个链接

📋 初始链接总数: 63
🔄 开始预处理链接...

📜 历史记录检测: 发现 63 个已完成的任务
⏭️  已自动跳过，剩余 0 个任务

✅ 所有任务都已完成，无需重复下载！
```

## 历史记录文件格式

历史记录以 JSON 格式保存在 `history` 目录中：

```json
{
  "task_id": "经典专辑.txt_1704067200",
  "task_file": "经典专辑.txt",
  "start_time": "2024-01-01T10:00:00Z",
  "end_time": "2024-01-01T12:30:00Z",
  "total_count": 63,
  "success_count": 60,
  "failed_count": 2,
  "skipped_count": 1,
  "records": [
    {
      "url": "https://music.apple.com/cn/album/vivaldi-the-four-seasons/883897569",
      "album_id": "883897569",
      "album_name": "Vivaldi: The Four Seasons",
      "artist_name": "Antonio Vivaldi",
      "status": "success",
      "download_at": "2024-01-01T10:05:30Z",
      "error_msg": ""
    },
    ...
  ]
}
```

### 字段说明

| 字段 | 说明 |
|------|------|
| `task_id` | 任务唯一标识符 |
| `task_file` | 原始TXT文件路径 |
| `start_time` | 任务开始时间 |
| `end_time` | 任务结束时间 |
| `total_count` | 任务总数 |
| `success_count` | 成功数量 |
| `failed_count` | 失败数量 |
| `skipped_count` | 跳过数量 |
| `records` | 详细记录列表 |

### 记录状态

- `success`: 下载成功
- `failed`: 下载失败
- `skipped`: 已跳过（文件已存在）

## 高级功能

### 1. 多任务文件管理

程序会自动识别不同的TXT文件，各自维护独立的历史记录：

```bash
# 不同的任务文件互不影响
./apple-music-downloader 经典专辑.txt    # 历史记录A
./apple-music-downloader 流行音乐.txt    # 历史记录B
```

### 2. 混合模式支持

历史记录功能在以下场景中自动启用：

- ✅ 交互模式输入TXT文件
- ✅ 命令行参数传入TXT文件
- ✅ 混合模式（URL + TXT文件）时，针对TXT文件启用

单个URL或纯URL列表不启用历史记录功能。

### 3. 手动管理历史记录

历史记录文件位于 `history` 目录，可以手动管理：

```bash
# 查看历史记录
ls -lh history/

# 删除特定任务的历史记录（重新下载）
rm history/经典专辑.txt_*.json

# 清空所有历史记录
rm -rf history/
```

## 注意事项

1. **历史记录基于URL匹配**：只有URL完全相同的任务才会被识别为已完成
2. **失败任务不会跳过**：只有状态为 `success` 的记录才会被跳过
3. **文件存在性检查**：即使历史记录显示成功，如果文件被手动删除，下次运行时会重新下载该歌曲
4. **历史记录自动保存**：每次批量任务结束时自动保存，无需手动操作

## 配合其他功能使用

### 与智能跳过配置配合

```yaml
# config.yaml
skip-existing-validation: true  # 自动跳过文件校验
```

结合历史记录功能，可以实现：
1. 历史记录跳过已下载的专辑（专辑级别）
2. 智能跳过检查已存在的文件（文件级别）
3. 双重保障，避免任何重复下载

### 与缓存机制配合

```yaml
# config.yaml
enable-cache: true
cache-folder: "./Cache"
```

缓存机制确保下载过程中的文件安全，历史记录确保任务级别的断点续传，两者互补。

## 故障排查

### 问题：历史记录未生效

**可能原因：**
1. TXT文件路径或名称发生变化
2. URL格式发生变化（如参数顺序）

**解决方案：**
- 保持TXT文件路径和名称不变
- 确保URL格式一致

### 问题：想要重新下载已完成的任务

**解决方案：**
```bash
# 删除对应的历史记录文件
rm history/你的任务文件名_*.json

# 或删除整个历史记录目录
rm -rf history/
```

## 总结

历史记录与进度管理功能为大规模批量下载任务提供了可靠的断点续传支持，特别适用于：

- 📚 大型音乐库的批量下载
- 🌐 网络不稳定环境下的分批下载
- ⏸️ 需要随时中断和恢复的长时间任务
- 🔄 定期更新音乐库（只下载新增内容）

配合智能跳过和缓存机制，可以实现高效、可靠、智能的批量下载体验！

